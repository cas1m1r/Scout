{% extends "base.html" %}
{% block title %}Results for {{ topic }}{% endblock %}
{% block content %}
<div class="card">
    <h2>üéØ Search Results: {{ topic }}</h2>
    <a href="/" class="btn">‚Üê Start New Search</a>
</div>
{% if results.alerts %}
<div class="card alert-card">
    <h3>üö® Alerts ({{ results.alerts|length }})</h3>
    <p>High-priority events requiring attention:</p>
    {% for alert in results.alerts %}
    <div class="story-item">
        <div class="story-title">{{ alert.primary_title }}</div>
        <div class="story-source"><a href="{{ alert.primary_link }}" target="_blank">{{ alert.primary_link }}</a></div>
        <div style="margin: 10px 0;">
            <span class="status-badge status-{{ alert.status }}">{{ alert.status }}</span>
            <span class="score">Score: {{ alert.score }}</span>
        </div>
        <div class="muted" style="font-size: 0.9rem;">
            Sources: {{ alert.domains|join(', ') }} | Stories: {{ alert.count }} | Latest: {{ alert.last_seen_gmt }}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% if results.clusters %}
<div class="card cluster-card">
    <h3>üìä All Clusters ({{ results.clusters|length }})</h3>
    {% for cluster in results.clusters %}
    <div class="story-item">
        <div class="story-title">{{ cluster.primary_title }}</div>
        <div class="story-source"><a href="{{ cluster.primary_link }}" target="_blank">{{ cluster.primary_link }}</a></div>
        <div style="margin: 10px 0;">
            <span class="status-badge status-{{ cluster.status }}">{{ cluster.status }}</span>
            <span class="score">Score: {{ cluster.score }}</span>
        </div>
        <div class="muted" style="font-size: 0.9rem;">
            Sources: {{ cluster.domains|join(', ') }} | Stories: {{ cluster.count }} | Latest: {{ cluster.last_seen_gmt }}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if second_stage %}
<h2 class="section-title">Second-stage Analysis</h2>
<div class="card">
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Priority</th>
          <th>Cluster ID</th>
          <th>Status</th>
          <th>Score</th>
          <th>Freshness</th>
          <th>Corrob.</th>
          <th>Max Count</th>
          <th>Momentum/hr</th>
          <th>Runs</th>
          <th>Topline</th>
        </tr>
      </thead>
      <tbody>
      {% for r in second_stage %}
        <tr>
          <td>{{ '%.2f'|format(r.priority or 0) }}</td>
          <td>
            <code>{{ r.cluster_id }}</code>
            {% if r.topic_group %}<span class="badge">{{ r.topic_group }}</span>{% endif %}
            {% if r.corroborated_flag %}<span class="badge badge-ok">corroborated</span>{% endif %}
            {% if r.murky_flag %}<span class="badge badge-warn">murky</span>{% endif %}
          </td>
          <td>{{ r.status_latest }}</td>
          <td>{{ r.last_score }}</td>
          <td>{{ r.freshness_latest }}</td>
          <td>{{ r.corroboration_latest }}</td>
          <td>{{ r.max_count }}</td>
          <td>{{ r.momentum_per_hr }}</td>
          <td>{{ r.runs }}</td>
          <td class="topline">{{ r.primary_title_latest }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Add the same emoji mapping onto titles so clusters/alerts get quick visual tags.
(function(){
  const EMOJI_RULES = [
    { re: /(fire|wildfire|smoke|burning)/i, emoji: "üöí" },
    { re: /(explosion|blast|bomb)/i, emoji: "üí•" },
    { re: /(shooting|gunshot|shots? fired|active shooter)/i, emoji: "üÜò" },
    { re: /(protest|demonstration|rally|clash|riot|march)/i, emoji: "‚úä" },
    { re: /(police|law enforcement|sheriff|federal agents|ICE|border patrol|troops|national guard|military)/i, emoji: "üëÆ" },
    { re: /(evacuation|evacuate|shelter[- ]?in[- ]?place|lockdown)/i, emoji: "üö®" },
    { re: /(storm|hurricane|tornado|severe weather|flood|rain|snow|blizzard)/i, emoji: "‚õàÔ∏è" },
    { re: /(earthquake|seismic|aftershock)/i, emoji: "üåé" },
    { re: /(power outage|blackout)/i, emoji: "üîå" },
    { re: /(road closed|closure|traffic|bridge|highway)/i, emoji: "üöß" },
  ];
  function emojiFor(text){
    for(const rule of EMOJI_RULES){ if(rule.re.test(text)) return rule.emoji; }
    return "üìù";
  }
  // Cluster/alert titles
  document.querySelectorAll('.story-title').forEach(el => {
    const txt = el.textContent || '';
    el.textContent = `${emojiFor(txt)} ${txt}`;
  });
  // Second-stage toplines (optional)
  document.querySelectorAll('td.topline').forEach(el => {
    const txt = el.textContent || '';
    el.textContent = `${emojiFor(txt)} ${txt}`;
  });
})();
</script>
{% endblock %}
